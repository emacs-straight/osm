#+title: osm.el - OpenStreetMap viewer for Emacs
#+author: Daniel Mendler
#+language: en
#+export_file_name: osm.texi
#+texinfo_dir_category: Emacs misc features
#+texinfo_dir_title: Osm: (osm).
#+texinfo_dir_desc: OpenStreetMap viewer for Emacs

#+html: <a href="https://www.gnu.org/software/emacs/"><img alt="GNU Emacs" src="https://github.com/minad/corfu/blob/screenshots/emacs.svg?raw=true"/></a>
#+html: <a href="https://elpa.gnu.org/packages/osm.html"><img alt="GNU ELPA" src="https://elpa.gnu.org/packages/osm.svg"/></a>
#+html: <a href="https://elpa.gnu.org/devel/osm.html"><img alt="GNU-devel ELPA" src="https://elpa.gnu.org/devel/osm.svg"/></a>
#+html: <a href="https://melpa.org/#/osm"><img alt="MELPA" src="https://melpa.org/packages/osm-badge.svg"/></a>
#+html: <a href="https://stable.melpa.org/#/osm"><img alt="MELPA Stable" src="https://stable.melpa.org/packages/osm-badge.svg"/></a>
#+html: <img src="https://github.com/minad/osm/blob/screenshots/osm.png?raw=true"/><p><i>The map data is © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, licensed under the <a href="https://opendatacommons.org/licenses/odbl/">ODbL</a> The map rendering is © <a href="https://opentopomap.org/about">OpenTopoMap</a>, licensed under the <a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA.</a></i></p>

Osm.el is a tile-based map viewer, with a responsive movable and zoomable
display. The map can be controlled with the keyboard or with the mouse. The
viewer fetches the map tiles in parallel from tile servers via the =curl= program.
The package comes with a list of multiple preconfigured tile servers. You can
bookmark your favorite locations using regular Emacs bookmarks or create links
from Org files to locations. Furthermore the package provides commands to search
for locations by name and to open and display GPX tracks.

#+toc: headlines 8

* Features

- Responsive, zoomable and movable map display
- Display of tracks and POIs from GPX file
- Parallel fetching of tiles with curl
- Moving in large and small steps
- Mouse support (dragging, clicking, menu)
- Map scale indicator
- Go to coordinate
- Search for location by name
- Org link, Geo url and Elisp link support
- Bookmarked positions with pins
- Multiple preconfigured tile servers

* Configuration

The package is available on GNU ELPA and can be installed with =package-install=.
Note that Osm.el requires Emacs 27 and depends on the external =curl= program.
Emacs must be built with =libxml=, =libjansson=, =librsvg=, =libjpeg= and =libpng=
support. The following is an example configuration which relies on =use-package=.
Please take a look at the [[https://github.com/minad/osm/wiki][wiki]] for additional configuration.

#+begin_src emacs-lisp
(use-package osm
  :bind ("C-c m" . osm-prefix-map) ;; Alternative: `osm-home'

  :custom
  ;; Take a look at the customization group `osm' for more options.
  (osm-server 'default) ;; Configure the tile server
  (osm-copyright t)     ;; Display the copyright information

  :init
  ;; Load Org link support
  (with-eval-after-load 'org
    (require 'osm-ol))

  :config

  ;; Add custom servers
  ;; (osm-add-server 'myserver
  ;;   :name "My tile server"
  ;;   :group "Custom"
  ;;   :description "Tiles based on aerial images"
  ;;   :url "https://myserver/tiles/%z/%x/%y.png?apikey=%k")
)
#+end_src

* Bookmarks, Org links, Geo urls and Elisp links

There exist multiple methods to store the current location.

- ~b~: Create a bookmark of the current location.
- ~l~: Store an Org link to the current location. The link can the be inserted
  into an Org buffer with ~C-c C-l~.
- ~u~: Save the geo url of the current location in the kill ring. The url can be
  inserted in another buffer via ~C-y~.
- ~C-u u~: Save an Elisp link to the current location in the kill ring.

Bookmarks and Org links can be created at point with the mouse, see
~osm-bookmark-set-click~ and ~osm-org-link-click~.

**** Org link examples

Click on a link or press ~RET~ to jump to the location. These links work in Org
buffers in Emacs. Furthermore you can open Org links in arbitrary buffers with
~org-open-at-point-global~. I recommend binding the command to a convenient key,
e.g., ~C-c o~. The format of the links complies with the [[https://en.wikipedia.org/wiki/Geo_URI_scheme][geo URI scheme]] defined by
[[https://datatracker.ietf.org/doc/html/rfc5870][RFC 5870]].

#+begin_example
  [[geo:41.869560826994544,12.45849609375;z=6;s=opentopomap][Italia, 41.87° 12.46° OpenTopoMap]]
  [[geo:51.48950698022105,-0.144195556640625;z=11][London, England, 51.49° -0.14°]]
  [[geo:55.686875255964424,12.569732666015625;z=12;s=cyclosm][København, Danmark, 55.69° 12.57° CyclOSM]]
  [[geo:27.961656050984658,86.89224243164062;z=13;s=opentopomap][Mount Everest, 27.96° 86.89° OpenTopoMap]]
  <geo:Tour Eiffel, Av. Gustave Eiffel, Paris> (Address link)
#+end_example

**** Elisp link examples

Place the point behind the closing parenthesis and press ~C-x C-e~ to jump to the
location. The Elisp links can be used in arbitrary text files. Since they are
Elisp s-expressions they can be easily manipulated programatically.

#+begin_src emacs-lisp
  (osm 41.869561 12.458496 6 'opentopomap "Lazio, Italia")
  (osm 51.489507 -0.144196 11 "London, Greater London, England, SW1A 2DX, United Kingdom")
  (osm 55.686875 12.569733 12 'cyclosm "København, Københavns Kommune, Region Hovedstaden, 1357, Danmark")
  (osm 27.961656 86.892242 13 'opentopomap "Khumjung, Khumbupasanglahmu, सोलुखुम्बु, Province #1, Nepal")
  (osm "Tour Eiffel, Av. Gustave Eiffel, Paris") ;; Address link
#+end_src

* Commands and Key Bindings

Top-level commands in =osm-prefix-map=:
- ~h~: =osm-home= - Open new map at home coordinates
- ~s~: =osm-search= - Search and jump to location
- ~t~: =osm-goto= - Go to coordinates
- ~v~: =osm-server= - Select server
- ~j~: =osm-bookmark-jump= - Jump to bookmark
- ~x~: =osm-gpx-show= - Show GPX file in map viewer

Additional key bindings in =osm-mode= buffer:
- ~<arrow>~: Small step scrolling
- ~C-<arrow>~, ~M-<arrow>~: Large step scrolling
- ~+~, ~SPC~: =osm-zoom-in= - Zoom in
- ~-~, ~S-SPC~: =osm-zoom-out= - Zoom out
- ~<mouse-1>~: =osm-transient-click= - Place transient pin at point
- ~<mouse-2>~: =osm-org-link-click= - Store point as Org link
- ~<mouse-3>~: =osm-bookmark-set-click= - Store point as bookmark
- ~<osm-bookmark mouse-*>~: =osm-bookmark-delete-click= - Click on bookmark at point to delete
- ~<down-mouse-*>~: =osm-mouse-drag= - Drag the map with the mouse
- ~d~, ~DEL~: =osm-bookmark-delete= - Delete selected bookmark
- ~c~: =osm-center= - Center to currently marked pin
- ~X~: =osm-gpx-hide= - Hide overlays from GPX file
- ~l~: =org-store-link= - Store Org link
- ~u~: =osm-save-url= - Save geo url in the kill ring
- ~b~: =osm-bookmark-set= - Set bookmark
- ~n~: =osm-bookmark-rename= - Rename selected bookmark
- ~q~: =quit-window= - Close buffer and window
- ~o~: =clone-buffer= - Clone buffer

* Related projects

There have been other attempts at map viewers in Emacs before.

- https://github.com/ruediger/osm-mode
- https://github.com/svenssonjoel/Emacs-OSM
- https://github.com/jd/google-maps.el
- https://github.com/emacsattic/org-osm-link

* Contributions

Since this package is part of [[https://elpa.gnu.org/packages/osm.html][GNU ELPA]] contributions require a copyright
assignment to the FSF.
